# 消息队列

[TOC]
## 消息模型

![image](https://upload-images.jianshu.io/upload_images/5015984-066ff248d5ff8eed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/401)

消费者（consumer）订阅某个队列。生产者（producer）创建消息，然后发布到队列（queue）中，最后将消息发送到监听的消费者。

## 基本概念


![image](https://upload-images.jianshu.io/upload_images/5015984-367dd717d89ae5db.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/554)

- **Channel：** 信道，多路复用连接中的一条独立的双向数据流通道。信道是建立在真实的TCP连接内地虚拟连接，AMQP 命令都是通过信道发出去的，不管是发布消息、订阅队列还是接收消息，这些动作都是通过信道完成。
因为对于操作系统来说建立和销毁 TCP 都是非常昂贵的开销，所以引入了信道的概念，以复用一条 TCP 连接。

- **Exchange：** 交换器，用来接收生产者发送的消息并将这些消息路由给服务器中的队列。

- **Binding：** 绑定，用于消息队列和交换器之间的关联。一个绑定就是基于路由键将交换器和消息队列连接起来的路由规则，所以可以将交换器理解成一个由绑定构成的路由表。

生产者把消息发布到 Exchange ，而 Binding 决定交换器的消息应该发送到那个队列。

- **Virtual Host：** 虚拟主机，表示一批交换器、消息队列和相关对象。虚拟主机是共享相同的身份认证和加密环境的独立服务器域。每个 vhost 本质上就是一个 mini 版的 RabbitMQ 服务器，拥有自己的队列、交换器、绑定和权限机制。vhost 是 AMQP 概念的基础，必须在连接时指定，RabbitMQ 默认的 vhost 是 / 。

- **Broker：** 表示消息队列服务器实体。


## 消息持久化

- 在配置中降queue，exchange和Message都持久化。


## 消息应答机制

- 消费者在收到消息并完成任务后会通知消息队列可以在内存中删除这条消息了。防止消费者挂掉的情况下造成消息丢失。

- 消息应答是默认打开的。
       
## 怎么保证数据不丢失

- 开启消费者自动应答，不消费完就不会删除消息

- 持久化消息队列(queue)，持久化消息(message)，避免宕机的时候数据丢失

## 消息队列应用场景

- 分布式系统中各个模块可以通过异步传输实现服务调用

- 高并发的时候缓解服务器压力(比如：发短信，发邮件，放款，代扣) 


